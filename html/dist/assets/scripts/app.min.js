var Stump=function(){};Stump.WindowView=Patchbay.View.extend({el:window,setup:function(){this.app=window.app,this.set("isResizing",!1),this.set("isScrolling",!1),this.buildSize(),this.buildScroll(),this.buildEvent(),this.listenTo(this.$el,"resize",_.bind(this.onResize,this)).listenTo(this.$el,"scroll",_.bind(this.onScroll,this)),_.delay(function(i){i.$el.trigger("resize").trigger("scroll")},250,this)},buildScroll:function(){var i=this.$el.scrollTop();this.scroll={scrollTop:i,scrollBottom:i+this.size.height}},buildSize:function(){this.size={width:this.$el.width(),height:this.$el.height(),screenWidth:this.el.outerWidth,screenHeight:this.el.outerHeight}},buildEvent:function(){this.data=_.extend({isResizing:this.get("isResizing"),isScrolling:this.get("isScrolling"),scrollTop:this.get("scrollTop")},this.size,this.scroll)},onResize:_.throttle(function(){this.buildSize(),this.buildEvent(),this.get("isResizing")||this.resizeStart(),this.trigger("resize",this.data),clearTimeout(this.resizeTimer),this.resizeTimer=_.delay(_.bind(this.resizeEnd,this),100)},25),resizeStart:function(){this.set("isResizing",!0),this.trigger("resize:start",this.data)},resizeEnd:function(){this.set("isResizing",!1),this.trigger("resize:end",this.data)},onScroll:_.throttle(function(){this.buildScroll(),this.buildEvent(),this.get("isScrolling")||this.scrollStart(),this.trigger("scroll",this.data),clearTimeout(this.scrollTimer),this.scrollTimer=_.delay(_.bind(this.scrollEnd,this),100)},25),scrollStart:function(){this.set("isScrolling",!0),this.app.state("scrolling",!0),this.trigger("scroll:start",this.data)},scrollEnd:function(){this.set("isScrolling",!1),this.app.state("scrolling",!1),this.trigger("scroll:end",this.data)}}),Stump.CellView=Patchbay.View.extend({setup:function(){this.listenTo(app.window,"resize",this.resize),this.resize()},resize:function(){this.$el.hasClass("cell-full")&&this.$el.css("min-height",window.innerHeight)}}),Stump.ImageView=Patchbay.View.extend({setup:function(){this.debounce=250,this.src=this.$el.attr("data-src"),this.listenTo(app.window,"resize",this.resize),this.setupPreloader(),this.preloadImage()},setupPreloader:function(){this.ui.preloader=$(document.createElement("div")).addClass("image-preloader"),this.spinner=new Spinner({lines:17,length:7,width:2,radius:15,corners:0,color:"#999",speed:1.2,trail:10,hwaccel:!0}).spin(),this.ui.preloader.append(this.spinner.el),this.$el.append(this.ui.preloader)},preloadImage:function(){var i=this,t=_.debounce(function(){i.srcHeight=this.height,i.srcidth=this.width,i.ratio=this.height/this.width,i.state("loaded",!0),i.trigger("loaded",!0),i.$el.css("background-image","url("+i.src+")"),i.resize(),_.delay(function(){i.spinner.stop(),i.ui.preloader.remove()},500)},this.debounce);this.image=new Image,this.image.onabort=t,this.image.onerror=t,this.image.onload=t,this.image.src=this.src},resize:function(){!this.$el.hasClass("image-square")}}),Stump.CasestudyView=Patchbay.View.extend({ui:{infoControl:".project-nav-information",galleryControl:".project-nav-gallery",closeControl:".project-nav-close",description:".project-description",selector:".project-selector",gallery:".project-gallery",wrapper:".gallery-wrapper",nav:".project-nav",images:".image"},setup:function(){this.inview=this.addChild(this.el,Stump.InView),this.gallery=this.addChild(this.$el,Stump.GalleryView),this.gallery.casestudy=this,this.listenOnce(this.inview,"inview",function(){this.images=this.addChild(this.ui.images,Stump.ImageView),this.listenTo(this.ui.images,"click",_.bind(this.expand,this)),this.inview.destroy()}),this.listenTo(this.ui.infoControl,"click",_.bind(this.collapse,this)),this.listenTo(this.ui.galleryControl,"click",_.bind(this.controlExpand,this)),this.listenTo(this.ui.closeControl,"click",_.bind(this.collapse,this)),this.listenTo(app.window,"resize",this.resize),this.listenTo(app.window,"scroll",this.resize)},collapse:function(){this.tempState("animating",!0),this.tempState("collapsing",!0),this.state("expanded",!1),this.trigger("collapse"),clearTimeout(this.collapseTimer),this.collapseTimer=_.delay(function(i){i.tempState("animating",!0),$(window).resize()},500,this)},expand:function(){clearTimeout(this.collapseTimer),this.tempState("animating",!0),this.state("expanded",!0),this.trigger("expand")},controlExpand:function(){this.expand(),_.defer(function(i){0===i.gallery.images.length&&i.gallery.setActive(0)},this)},tempState:function(i,t,e){this.state(i,t),_.delay(function(e){e.state(i,!t)},e||500,this)},resize:function(i){var t=this.ui.description.outerHeight(),e=this.ui.selector.outerHeight(),s=_.max([this.ui.description.height(),this.ui.selector.height()]);this.lastHeight=this.minHeight,this.minHeight=(i.width>600?s:t+e)+.1*i.width,this.$el.attr("data-min",this.minHeight),this.$el.attr("data-max",i.height)}}),Stump.InView=Patchbay.View.extend({setup:function(){var i=this;this.measure=_.wrap(this.measure,function(t){t.apply(this,_.rest(arguments).concat([i.uid]))}),this.callback=_.bind(function(){this.measure(app.window.data)},this),$(window).on("scroll resize",this.callback),this.callback()},measure:function(i){this.height=this.$el.outerHeight(),this.top=this.$el.offset().top,this.bottom=this.top+this.height,this.inTop=this.bottom>i.scrollTop,this.inBottom=this.top<i.scrollBottom,this.inView=this.inTop&&this.inBottom,this.inviewState(this.inView)},inviewState:function(i){this.state("inview",i),i&&this.trigger("inview",_.pick(this,"height","top","bottom","inTop","inBottom","inView"))},cleanup:function(){$(window).off("scroll",this.callback),$(window).off("resize",this.callback)}}),Stump.GalleryView=Patchbay.View.extend({ui:{selectors:".gallery-selector",wrapper:".gallery-wrapper",items:".gallery-item"},setup:function(){this.itemTemplate=_.template('<div class="gallery-item" data-index="<%= index %>"><div class="image" data-src="<%= src %>"></div></div>'),this.images=[],this.addedImages=[],this.position=0,this.getImages(),this.hammer=new Hammer(this.ui.wrapper[0]),this.hammer.on("dragstart",_.bind(this.dragStart,this)).on("drag",_.bind(this.dragMove,this)).on("dragend",_.bind(this.dragEnd,this)),this.listenTo(app.window,"resize",this.resize),this.listenTo(this.ui.selectors,"click",_.bind(this.onItemClick,this)),this.listenTo(this,"drag:left",this.prev),this.listenTo(this,"drag:right",this.next)},afterSetup:function(){this.listenTo(this.casestudy,"expand",function(){this.expanded=!0,this.oldScroll=$("body").scrollTop(),$("body").animate({scrollTop:this.$el.offset().top},500),this.resize(app.window.data)}),this.listenTo(this.casestudy,"collapse",function(){this.expanded=!1,this.resize(app.window.data)}),_.delay(function(i){i.resize(app.window.data)},250,this)},dragStart:function(){this.delta=0,this.trigger("drag:start"),this.state("dragging",!0),this.startPosition=this.position},dragMove:function(i){this.lastDelta=this.delta,this.delta=i.gesture.deltaX,this.position=this.startPosition+i.gesture.deltaX,this.offset=this.position+this.wrapperWidth*this.elIndex,this.trigger("drag"),this.updateDirection(),this.positionElements(this.offset)},dragEnd:function(){this.trigger("drag:end"),this.state("dragging",!1),this.tempState("animating",!0)},updateDirection:_.throttle(function(){this.lastDirection=this.direction,this.direction=this.delta<this.lastDelta?"left":"right",this.lastDirection!==this.direction&&this.changeDirection(this.direction)},50),changeDirection:function(i){this.trigger("drag:"+i)},positionElements:function(i){var t=this;this.ui.items.each(function(e){var s=t.wrapperWidth*e+i;$(this).css("transform","translate3d("+s+"px, 0, 0)")})},cleanupElements:function(){},onItemClick:function(i){var t=$(i.currentTarget).attr("data-index");this.setActive(parseInt(t))},resize:function(i){var t,e;this.state("expanded")?(e=i.width>600?0:.1*i.width,t=i.height+e):t=this.$el.attr("data-min"),this.wrapperWidth=1.025*this.ui.wrapper.innerWidth(),this.$el.css("height",t),this.setImagesOffset(i),this.positionElements(this.offset)},setActive:function(i){this.lastIndex=this.index,this.index=i,this.addImage(i),this.elIndex=this.ui.items.filter("[data-index="+i+"]").index(),this.ui.items.removeClass("is-active").filter("[data-index="+i+"]").addClass("is-active"),this.ui.selectors.removeClass("is-active").filter("[data-index="+i+"]").addClass("is-active")},setImagesOffset:function(i){this.ui.items.each(function(){var t=$(this),e=t.find(".image"),s=0;i.width<600&&(s=t.outerHeight()-e.outerHeight(),s/=2),t.css("padding-top",s)})},addImage:function(i){if(-1===_.indexOf(this.addedImages,i)){var t=_.find(this.imageData,function(t){return t.index===i}),e=$(this.itemTemplate(t));if(this.ui.items.length>0){var s=_.find(this.ui.items.get().reverse(),function(i){return t.index>$(i).attr("data-index")}),n=_.isUndefined(s)?this.ui.items.eq(0):$(s),a=_.isUndefined(s)?"before":"after";n[a](e)}else this.ui.wrapper.append(e);this.ui.items=this.$(".gallery-item");var h=Stump.ImageView.create({el:e.find(".image")},{debounce:1e3});this.images.push(),this.addedImages.push(i),$(window).trigger("resize"),this.listenOnce(h,"loaded",function(){$(window).trigger("resize")})}},getImages:function(){this.imageData=this.ui.selectors.map(function(i){var t=$(this);return t.attr("data-index",i),{index:i,src:t.attr("data-src")}}).get()},cleanup:function(){_.each(this.images,function(i){i.destroy()})},tempState:function(i,t,e){this.state(i,t),_.delay(function(e){e.state(i,!t)},e||500,this)}}),Stump.Application=Patchbay.View.extend({el:"#application",ui:{cells:".cell",casestudies:".project-casestudy"},setup:function(){this.state("starting",!0),_.delay(_.bind(this.state,this),250,"starting",!1),this.window=Stump.WindowView.create(),this.setupChildren()},setupChildren:function(){this.setupPage(),this.cells=this.addChild(this.ui.cells,Stump.CellView),this.casestudies=this.addChild(this.ui.casestudies,Stump.CasestudyView)},setupPage:function(){}}),$(function(){window.app=new Stump.Application});